[{"id":0,"href":"/projects/cider/control-system/","title":"Control System","section":"Cider","content":" A rudimentary control-system for home brewing # When I brewed beer some fifteen or more years ago, I was working with far more rudimentary tools than are available now. Microcontrolers were strange things that ran custom code (if anything) and their utility was obscure to a luddite like me. I have some basic electronics knowledge but still don\u0026rsquo;t really understand things like op-amps and the other modern paraphernalia of the trade, so anything I did would be pretty limited. Therefore, I resorted to analogue methods and regulated the temperature of my wort by running water through it using an aquarium pump and some PVC tubing. Crude but effective.\nThese days, things are much simpler - general purpose computers exist and are available in the form factor of a compact disk container (that\u0026rsquo;s approximately 20cm x 20cm for those of you who are too young to know what a CD is).\nI decided quite early on that I wanted to build an automated control system for any brewing vessel I used. Firstly, because its\u0026rsquo; cool, and secondly because I\u0026rsquo;m lazy and don\u0026rsquo;t want to have to walk downstairs multiple times a day to check temperatures. This is meant to be fun, not a job. So I needed a programmable controller of some sort.\nI possess an Arduino Nano which I bought as part of a previous (abandoned) project to build a computerised equatorial drive for a telescope.\nIt was a fun little toy, but two things hindered my intent to repurpose it for this project:\nIt didn\u0026rsquo;t have enough output pins to do what I suspected I wanted to do, and more importantly: I couldn\u0026rsquo;t find it. So I cursed a bit, did some requirements-gathering and went shopping.\nRequirements for the control system # Must have sufficient GPIO pins to be able to drive / interface with several devices, namely: Some sort of on-board temperature indicator, likely an LED Relays for a heating circuit and a separate cooling circuit A waterproof thermometer that I intended to immerse in my fermentation vessel for direct temperature tracking Must preferably not require me to write C++ Some sort of WiFi or Bluetooth connectivity would be fantastic from a remote monitoring point of view. At the very top of the list was the Rasberry Pi Pico W. It spoke C++ (boo) and Python (another, smaller boo) which meant I\u0026rsquo;d conceivably be able to program it without a Ph.D, and it was a very small form factor.\nSo I bought it.\nHardware # First of all, I wanted a digital thermometer that I could put into the fermentation vessel. I initially looked at using a Thermowell, but these are expensive and seem a little self-indulgent for a 5 litre fermentation vessel. So I did some searching on PiHut and found what I wanted in the DS18B20 waterproof digital thermometer.\nI was originally going to drive an array of LEDS (red, amber and green) to indicate whether the stock was at the correct temperature or not. However, in my cheap bunch of electronic parts that I\u0026rsquo;d bought previously, I found a RGB LED and decided to use it instead. So that gave me temperature and a way to show the range visually; I settled on five colours: red, amber, green, cyan and blue ranging from far too hot to far too cold. My intent was to have this LED taped somewhere visible so that a quick glance would show the status of the reaction.\nI realised that I would need some way to programatically control heating and cooling, so I also bought a dual-channel relay HAT for the pico. One Relay would drive the heating circuit which would be a brewing heat pad of some sort, the other would drive whatever cooling system I eventually decided to make use of. Given that I intend to start fermentation in late summer, my hope is that cooling will be less necessary as the reaction goes on.\nAfter some tinkering, I had a basic control system mocked up. I had one or two learning experiences, namely that I naively thought the thermometer would give analogue readings despite it clearly being described as a digital thermometer, and an amusing time during which I tried to decode the pins of the RGB LED with my multimeter in diode mode. Sigh.\nUltimately, though, I had a working circuit, and the software to drive it. With the help of the excellent Pico W Pinout diagram I did some soldering and managed not to destroy anything expensive.\nSoftware # The Pico drives the RGB LED through pins GP2, GP3 and GP4. GP8 is used for the digital temperature sensor, and needs to be raised to +VCC via a pull-up resistor. GP6 is the cooling relay and GP7 is the heating relay.\nThe control system is simple. A set of ranges are defined, and actions are taken based on where in the range the temperature reading falls. Essentially, if the thermometer reads below the \u0026ldquo;green\u0026rdquo; zone, the heating relay is turned on until temperature returns to the green zone. If the temperature is above the green zone, the cooling circuit is turned on. Nice and simple.\nFor visual checks I added five hues via the RGB LED - these are blue (way too cold), cyan (below ideal), green (ideal), amber (above ideal) and red (way too hot). A test routine at power on verifies that these are all functional.\nHowever, because I\u0026rsquo;m lazy, I also wanted to spool metrics to an observability platform. I have a little Lenovo Thinkcenter which runs Linux Mint. It\u0026rsquo;s a db server, a mumble server and does a couple of other things - like running VictoriaMetrics which remains the best timeseries system I\u0026rsquo;ve worked with from an SRE point of view.\nSo I did some research and found the microdot webserver, which seemed perfect to allow my Pico W to expose metrics.\nInstrumentation # It\u0026rsquo;s probably easiest to just dump the format string here:\n# HELP {appname}_led_status Status gauge for pico onboard led # TYPE {appname}_led_status gauge {appname}_led_status{{led=\u0026quot;LED\u0026quot;}} {machine.Pin(\u0026quot;LED\u0026quot;, mode=machine.Pin.OUT).value()} {appname}_led_status{{led=\u0026quot;RED\u0026quot;,pin=\u0026quot;{monitor.LED_PIN_RED}\u0026quot;}} {machine.Pin(monitor.LED_PIN_RED, mode=machine.Pin.OUT).value()} {appname}_led_status{{led=\u0026quot;GREEN\u0026quot;,pin=\u0026quot;{monitor.LED_PIN_GREEN}\u0026quot;}} {machine.Pin(monitor.LED_PIN_GREEN, mode=machine.Pin.OUT).value()} {appname}_led_status{{led=\u0026quot;BLUE\u0026quot;,pin=\u0026quot;{monitor.LED_PIN_BLUE}\u0026quot;}} {machine.Pin(monitor.LED_PIN_BLUE, mode=machine.Pin.OUT).value()} # HELP {appname}_sensor_temperature Temperature gauge for DS18B20 sensor which should be in the fermentation vessel # TYPE {appname}_sensor_temperature gauge {appname}_sensor_temperature{{type=\u0026quot;digital\u0026quot;,model=\u0026quot;ds18b20\u0026quot;,pin=\u0026quot;{monitor.TEMPERATURE_IN}\u0026quot;}} {monitor.last} # HELP {appname}_relay_state State of a relay on the fermentation chamber control circuit # TYPE {appname}_relay_state gauge {appname}_relay_state{{model=\u0026quot;{relaytype}\u0026quot;,pin=\u0026quot;{monitor.COOLING_RELAY}\u0026quot;}} {machine.Pin(monitor.COOLING_RELAY, mode=machine.Pin.OUT).value()} {appname}_relay_state{{model=\u0026quot;{relaytype}\u0026quot;,pin=\u0026quot;{monitor.HEATING_RELAY}\u0026quot;}} {machine.Pin(monitor.HEATING_RELAY, mode=machine.Pin.OUT).value()} And there we go. The pico is scraped on port 5000 and ships metrics (when it\u0026rsquo;s plugged in)\n"},{"id":1,"href":"/projects/cider/","title":"Cider","section":"Projects","content":"Many moons ago, I was on a trip in Dorset and we visited a country pub near Swanage, which I believe was the Square and Compass. I remember being very taken by the cider, which was apparently brewed locally and tasted totally different to the commercial ciders I was familiar with at that point.\nMany years later, I need a project, and the internal squirrel brain settled on the idea of doing some home fermentation. I\u0026rsquo;ve fermented beer before, which was drinkable but nothing special. Given that I live in Kent and am surrounded by apple orchards, it seemed a good idea to investigate cider-making.\nFrom experience, I knew I\u0026rsquo;d need some things, and I\u0026rsquo;d need to learn some other things. But one thing I definitely wanted to do was have some way to observe and track the fermentation process from the comfort of anywhere but the spider-infested horror that doubles as my garage.\nI also needed some way to protect my fermentation set-up from accidental kicks or other hazards, like having a spade fall on it.\nMy daytime job is SRE, so I decided to SRE the censored out of this.\nProject Progress # Initial discovery work Design of the Control Circuit "}]